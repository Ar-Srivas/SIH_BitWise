{% extends "template.html" %}

{% block title %}Assessment - EduHelp Pro{% endblock %}

{% block quiz_active %}dark:bg-gray-700 dark:text-white bg-[#ff8066]/20 text-[#ff8066]{% endblock %}

{% block page_icon %}üìù{% endblock %}
{% block page_title %}Knowledge Assessment{% endblock %}
{% block page_description %}Test your understanding and track your progress{% endblock %}

{% block tab_navigation %}
<div class="flex items-center space-x-3 sm:mt-7 mt-4">
    <a href="#" class="px-3 border-b-2 border-[#ff8066] text-[#ff8066] dark:text-white dark:border-white pb-1.5">Quiz</a>
    <a href="#" class="px-3 border-b-2 border-transparent text-gray-600 dark:text-gray-400 pb-1.5">Results</a>
</div>
{% endblock %}

{% block content %}
<!-- Question Card -->
<div id="question-card" class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <div id="question" class="text-lg font-medium text-gray-900 dark:text-white leading-relaxed">
        Loading your assessment...
    </div>
</div>

<!-- Options -->
<div id="options" class="grid gap-4 md:grid-cols-1 lg:grid-cols-2 mb-6"></div>

<!-- Back to Dashboard Button (appears after quiz completion) -->
<div id="quiz-actions" class="flex justify-center mt-6" style="display: none;">
    <button id="back-to-dashboard" class="px-6 py-3 bg-[#ff8066] text-white rounded-lg hover:bg-[#ff8066]/80 transition font-medium">
        Back to Dashboard
    </button>
</div>
{% endblock %}

{% block page_scripts %}
let quizData = [];
let currentQuestion = "q1";
let quizResult = {};
let userEmail = '';

const questionEl = document.getElementById('question');
const optionsEl = document.getElementById('options');

document.addEventListener('DOMContentLoaded', function() {
    // Get email from URL
    const urlParams = new URLSearchParams(window.location.search);
    userEmail = urlParams.get('email');

    if (!userEmail) {
        location.href = '/';
        return;
    }

    // Load quiz questions
    fetchQuestions();
});

async function fetchQuestions() {
    try {
        const response = await fetch('/static/questions.json');
        quizData = await response.json();
        loadQuestion(currentQuestion);
    } catch (error) {
        console.error('Error fetching questions:', error);
        questionEl.textContent = 'Failed to load questions. Please try again later.';
    }
}

function loadQuestion(questionId) {
    const currentQuiz = quizData.find(q => q.id === questionId);
    if (!currentQuiz) {
        endQuiz();
        return;
    }

    questionEl.textContent = currentQuiz.question;
    optionsEl.innerHTML = '';

    currentQuiz.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.classList.add(
            'w-full', 'p-4', 'text-left', 'bg-white', 'dark:bg-gray-800',
            'border', 'border-gray-300', 'dark:border-gray-600',
            'rounded-lg', 'hover:bg-gray-50', 'dark:hover:bg-gray-700',
            'hover:border-[#ff8066]', 'transition-colors', 'cursor-pointer',
            'text-gray-900', 'dark:text-white'
        );
        button.textContent = option.text;
        button.onclick = () => selectAnswer(option);
        optionsEl.appendChild(button);
    });
}

function selectAnswer(selectedOption) {
    // Record the answer if it has a category
    if (selectedOption.category) {
        if (!quizResult[selectedOption.category]) {
            quizResult[selectedOption.category] = 0;
        }
        quizResult[selectedOption.category]++;
    }

    // Move to next question or end quiz
    if (selectedOption.next) {
        currentQuestion = selectedOption.next;
        loadQuestion(currentQuestion);
    } else {
        endQuiz();
    }
}

function endQuiz() {
    questionEl.textContent = "üéâ Quiz Completed! Here are your results:";
    optionsEl.innerHTML = '';

    // Create results container
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700';

    // Display results
    if (Object.keys(quizResult).length > 0) {
        const resultsTitle = document.createElement('h3');
        resultsTitle.className = 'text-lg font-semibold text-gray-900 dark:text-white mb-4';
        resultsTitle.textContent = 'Your Learning Strengths:';
        resultsContainer.appendChild(resultsTitle);

        Object.entries(quizResult)
            .sort(([,a], [,b]) => b - a) // Sort by count descending
            .forEach(([category, count]) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700 last:border-b-0';

                const categorySpan = document.createElement('span');
                categorySpan.className = 'font-medium text-gray-900 dark:text-white';
                categorySpan.textContent = category;

                const countSpan = document.createElement('span');
                countSpan.className = 'text-[#ff8066] font-bold';
                countSpan.textContent = count;

                resultDiv.appendChild(categorySpan);
                resultDiv.appendChild(countSpan);
                resultsContainer.appendChild(resultDiv);
            });
    } else {
        const noResults = document.createElement('p');
        noResults.className = 'text-gray-600 dark:text-gray-400 text-center py-4';
        noResults.textContent = 'No results to display.';
        resultsContainer.appendChild(noResults);
    }

    optionsEl.appendChild(resultsContainer);

    // Show back to dashboard button
    document.getElementById('quiz-actions').style.display = 'flex';
    const backBtn = document.getElementById('back-to-dashboard');
    backBtn.onclick = function() {
        const email = getEmailFromURL();
        window.location.href = `/dashboard?email=${email}`;
    };

    // Save results to the database
    saveQuizResults(resultsContainer);
}

function saveQuizResults(resultsContainer) {
    if (Object.keys(quizResult).length === 0) {
        return;
    }

    fetch('/submit-quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `email=${userEmail}&quiz_result=${encodeURIComponent(JSON.stringify(quizResult))}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const successMsg = document.createElement('div');
            successMsg.className = 'mt-4 p-3 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-md text-center';
            successMsg.textContent = '‚úÖ Results saved successfully!';
            resultsContainer.appendChild(successMsg);
        } else {
            throw new Error('Failed to save results');
        }
    })
    .catch(error => {
        console.error('Error saving results:', error);
        const errorMsg = document.createElement('div');
        errorMsg.className = 'mt-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-md text-center';
        errorMsg.textContent = '‚ùå Failed to save results, but you can still return to the dashboard.';
        resultsContainer.appendChild(errorMsg);
    });
}
{% endblock %}