{% extends "template.html" %}

{% block title %}AI Assistant - EduHelp Pro{% endblock %}

{% block chat_active %}dark:bg-gray-700 dark:text-white bg-[#ff8066]/20 text-[#ff8066]{% endblock %}

{% block page_icon %}ðŸ¤–{% endblock %}
{% block page_title %}AI Assistant{% endblock %}
{% block page_description %}Get instant help with your academic questions{% endblock %}

{% block tab_navigation %}
<div class="flex items-center space-x-3 sm:mt-7 mt-4">
    <a href="#" class="px-3 border-b-2 border-[#ff8066] text-[#ff8066] dark:text-white dark:border-white pb-1.5">Chat</a>
    <a href="#" class="px-3 border-b-2 border-transparent text-gray-600 dark:text-gray-400 pb-1.5">History</a>
</div>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div id="welcomeContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6 text-center border border-gray-200 dark:border-gray-700">
    <div class="text-4xl mb-4">ðŸ¤–</div>
    <h1 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Welcome to EduHelp Pro</h1>
    <p class="text-gray-600 dark:text-gray-400 mb-6">How can I assist you with your learning today?</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg cursor-pointer hover:shadow-md transition border border-gray-200 dark:border-gray-700"
             onclick="sendSuggestion('Explain quantum physics concepts')">
            <h3 class="font-medium text-[#ff8066] mb-1">Study Help</h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm">Explain quantum physics concepts</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg cursor-pointer hover:shadow-md transition border border-gray-200 dark:border-gray-700"
             onclick="sendSuggestion('Help me solve this math problem')">
            <h3 class="font-medium text-[#ff8066] mb-1">Math Assistance</h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm">Help me solve this math problem</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg cursor-pointer hover:shadow-md transition border border-gray-200 dark:border-gray-700"
             onclick="sendSuggestion('Create a study schedule for finals')">
            <h3 class="font-medium text-[#ff8066] mb-1">Study Planning</h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm">Create a study schedule for finals</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg cursor-pointer hover:shadow-md transition border border-gray-200 dark:border-gray-700"
             onclick="sendSuggestion('Review my essay for grammar')">
            <h3 class="font-medium text-[#ff8066] mb-1">Writing Help</h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm">Review my essay for grammar</p>
        </div>
    </div>
</div>

<!-- Chat Messages -->
<div id="chatMessages" class="flex flex-col space-y-4 mb-6"></div>

<!-- Input Area -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
    <form id="inputForm" class="flex items-end space-x-3">
        <textarea
            id="userInput"
            class="flex-grow resize-none border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-[#ff8066]"
            placeholder="Send a message..."
            rows="1"
            autocomplete="off"
        ></textarea>
        <button type="submit" class="bg-[#ff8066] hover:bg-[#ff8066]/80 text-white px-4 py-2 rounded-md flex items-center">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </form>
</div>
{% endblock %}

{% block page_scripts %}
const chatMessages = document.getElementById('chatMessages');
const welcomeContainer = document.getElementById('welcomeContainer');
const inputForm = document.getElementById('inputForm');
const userInput = document.getElementById('userInput');
let isThinking = false;

if (userInput) {
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
}

function addMessage(sender, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex flex-col ${sender === 'user' ? 'items-end' : 'items-start'}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm max-w-lg border border-gray-200 dark:border-gray-700';
    contentDiv.innerHTML = content.replace(/\n/g, '<br>');

    const headerDiv = document.createElement('div');
    headerDiv.className = 'flex items-center mb-1 space-x-2 text-sm';
    const avatar = document.createElement('div');
    avatar.className = 'w-6 h-6 flex items-center justify-center rounded-full bg-[#ff8066] text-white text-xs font-bold';
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    const label = document.createElement('span');
    label.textContent = sender === 'user' ? 'You' : 'EduHelp Pro';
    headerDiv.appendChild(avatar);
    headerDiv.appendChild(label);

    messageDiv.appendChild(headerDiv);
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    if (isThinking) return;
    isThinking = true;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'flex flex-col items-start';
    typingDiv.id = 'typing-indicator';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'flex items-center mb-1 space-x-2 text-sm';
    const avatar = document.createElement('div');
    avatar.className = 'w-6 h-6 flex items-center justify-center rounded-full bg-[#ff8066] text-white text-xs font-bold';
    avatar.textContent = 'AI';
    const label = document.createElement('span');
    label.textContent = 'EduHelp Pro';
    headerDiv.appendChild(avatar);
    headerDiv.appendChild(label);

    const contentDiv = document.createElement('div');
    contentDiv.className = 'bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700';
    contentDiv.innerHTML = '<span>Thinking...</span>';

    typingDiv.appendChild(headerDiv);
    typingDiv.appendChild(contentDiv);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) typingIndicator.remove();
    isThinking = false;
}

function sendSuggestion(text) {
    if (welcomeContainer) welcomeContainer.style.display = 'none';
    sendMessage(text);
}

async function sendMessage(message) {
    if (isThinking) return;
    const text = message || (userInput ? userInput.value.trim() : '');
    if (!text) return;

    if (welcomeContainer) welcomeContainer.style.display = 'none';
    addMessage('user', text);

    if (!message && userInput) {
        userInput.value = '';
        userInput.style.height = 'auto';
    }

    showTypingIndicator();

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_message: text })
        });

        hideTypingIndicator();

        if (!response.ok) throw new Error('HTTP error: ' + response.status);
        const data = await response.json();
        addMessage('bot', data.response || 'Sorry, empty response received.');
    } catch (err) {
        hideTypingIndicator();
        console.error(err);
        addMessage('bot', 'Sorry, an error occurred. Please try again.');
    }
}

if (inputForm) inputForm.addEventListener('submit', e => { e.preventDefault(); sendMessage(); });
if (userInput) userInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
{% endblock %}